{% extends "base.html" %}

{% block title %}Notes - WanderWallet{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-dark-primary via-dark-secondary to-dark-primary py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">Keep Notes</h1>
            <p class="text-gray-400">Organize your thoughts, ideas, and important reminders</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
                <div class="glass-card p-6 sticky top-20">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-plus-circle mr-3 text-teal-primary"></i>
                        <span id="formTitle">Create New Note</span>
                    </h2>
                    <form id="noteForm" class="space-y-4">
                        <input type="hidden" id="noteId" value="">
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Title</label>
                            <input type="text" id="noteTitle" name="title" required
                                   class="input-field" placeholder="Enter note title">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Content</label>
                            <textarea id="noteContent" name="content" required rows="8"
                                      class="input-field resize-none" placeholder="Write your note here..."></textarea>
                        </div>
                        
                        <div class="flex gap-3">
                            <button type="submit" class="btn-primary flex-1" id="submitBtn">
                                <i class="fas fa-save mr-2"></i>
                                <span id="submitText">Save Note</span>
                            </button>
                            <button type="button" class="btn-secondary" id="cancelBtn" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="lg:col-span-2">
                <div class="mb-4 flex items-center justify-between">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-sticky-note mr-3 text-purple-primary"></i>
                        Your Notes
                    </h2>
                    <div class="text-sm text-gray-400">
                        <span id="noteCount">{{ notes|length }}</span> note{% if notes|length != 1 %}s{% endif %}
                    </div>
                </div>
                
                <div id="notesContainer" class="space-y-4">
                    {% if notes %}
                        {% for note in notes %}
                        <div class="glass-card p-6 note-card" data-note-id="{{ note.id }}">
                            <div class="flex items-start justify-between mb-3">
                                <h3 class="text-lg font-bold text-white flex-1 note-title">{{ note.title }}</h3>
                                <div class="flex items-center gap-2 ml-4">
                                    <button onclick="editNote({{ note.id }})" class="text-teal-primary hover:text-teal-secondary transition-colors p-2" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteNote({{ note.id }})" class="text-red-400 hover:text-red-300 transition-colors p-2" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-gray-300 whitespace-pre-wrap mb-3 note-content">{{ note.content }}</div>
                            <div class="flex items-center justify-between text-xs text-gray-500 border-t border-gray-700 pt-3">
                                <div>
                                    <i class="fas fa-clock mr-1"></i>
                                    Created: {{ note.created_at.split('.')[0] if '.' in note.created_at else note.created_at }}
                                </div>
                                {% if note.updated_at != note.created_at %}
                                <div>
                                    <i class="fas fa-pen mr-1"></i>
                                    Updated: {{ note.updated_at.split('.')[0] if '.' in note.updated_at else note.updated_at }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="glass-card p-12 text-center" id="emptyState">
                            <i class="fas fa-sticky-note text-6xl text-gray-600 mb-4"></i>
                            <h3 class="text-xl font-bold mb-2 text-gray-400">No notes yet</h3>
                            <p class="text-gray-500">Create your first note to get started!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let editingNoteId = null;
const notesData = {{ notes|tojson|safe }};

document.getElementById('noteForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const title = document.getElementById('noteTitle').value.trim();
    const content = document.getElementById('noteContent').value.trim();
    const noteId = document.getElementById('noteId').value;
    
    if (!title || !content) {
        alert('Please fill in all fields');
        return;
    }
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    
    try {
        let response;
        if (noteId) {
            response = await fetch(`/api/notes/${noteId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title, content })
            });
        } else {
            response = await fetch('/notes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title, content })
            });
        }
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'An error occurred');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while saving the note');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i><span id="submitText">Save Note</span>';
    }
});

function editNote(noteId) {
    const note = notesData.find(n => n.id === noteId);
    if (!note) return;
    
    document.getElementById('noteId').value = noteId;
    document.getElementById('noteTitle').value = note.title;
    document.getElementById('noteContent').value = note.content;
    document.getElementById('formTitle').textContent = 'Edit Note';
    document.getElementById('submitText').textContent = 'Update Note';
    document.getElementById('cancelBtn').style.display = 'block';
    
    editingNoteId = noteId;
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.getElementById('cancelBtn').addEventListener('click', () => {
    resetForm();
});

function resetForm() {
    document.getElementById('noteForm').reset();
    document.getElementById('noteId').value = '';
    document.getElementById('formTitle').textContent = 'Create New Note';
    document.getElementById('submitText').textContent = 'Save Note';
    document.getElementById('cancelBtn').style.display = 'none';
    editingNoteId = null;
}

async function deleteNote(noteId) {
    if (!confirm('Are you sure you want to delete this note?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/notes/${noteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'An error occurred');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while deleting the note');
    }
}
</script>

{% endblock %}
